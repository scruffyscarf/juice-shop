name: Trivy Security Scan with SBOM

on:
  push:
    branches: [ main ]

jobs:
  trivy-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install Trivy
      run: |
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
        trivy --version

    - name: Update Trivy database
      run: |
        trivy image --download-db-only

    - name: Generate SBOM
      run: |
        # Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ SBOM Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ CycloneDX
        trivy fs . --format cyclonedx --output sbom.json
        echo "SBOM generated successfully"

    - name: Scan SBOM for vulnerabilities
      run: |
        # Ğ¡ĞºĞ°Ğ½Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ°Ğ¼ SBOM Ğ½Ğ° ÑƒÑĞ·Ğ²Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
        trivy sbom sbom.json --format json --output sbom-vulnerabilities.json
        echo "SBOM vulnerability scan completed"

    - name: Scan filesystem for vulnerabilities
      run: |
        # ĞŸĞ¾Ğ»Ğ½Ğ¾Ğµ ÑĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²Ğ¾Ğ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹
        trivy fs . \
          --format json \
          --output fs-vulnerabilities.json \
          --scanners vuln \
          --severity CRITICAL,HIGH,MEDIUM,LOW
        echo "Filesystem vulnerability scan completed"

    - name: Scan for secrets and config issues
      run: |
        # Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ ÑĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞµĞºÑ€ĞµÑ‚Ğ¾Ğ² Ğ¸ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¾Ğ²
        trivy fs . \
          --format json \
          --output secrets-config.json \
          --scanners secret,config \
          --severity CRITICAL,HIGH,MEDIUM,LOW
        echo "Secrets and config scan completed"

    - name: Create comprehensive JSON report
      run: |
        # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ jq Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ JSON
        sudo apt-get install -y jq
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑĞ²Ğ¾Ğ´Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡ĞµÑ‚
        cat > comprehensive-security-report.json << 'EOF'
        {
          "scanMetadata": {
            "scanner": "Trivy",
            "version": "$(trivy --version | head -1 | cut -d' ' -f2)",
            "timestamp": "$(date -Iseconds)",
            "repository": "${{ github.repository }}",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}"
          },
          "sbomAnalysis": {
            "componentsCount": $(jq '.components | length' sbom.json 2>/dev/null || echo "0"),
            "vulnerabilitiesFound": $(jq '.Results | length' sbom-vulnerabilities.json 2>/dev/null || echo "0")
          },
          "vulnerabilitySummary": {
            "filesystemScan": {
              "targetsScanned": $(jq '.Results | length' fs-vulnerabilities.json 2>/dev/null || echo "0"),
              "vulnerabilitiesBySeverity": {
                "CRITICAL": $(jq '[.Results[].Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' fs-vulnerabilities.json 2>/dev/null || echo "0"),
                "HIGH": $(jq '[.Results[].Vulnerabilities[]? | select(.Severity == "HIGH")] | length' fs-vulnerabilities.json 2>/dev/null || echo "0"),
                "MEDIUM": $(jq '[.Results[].Vulnerabilities[]? | select(.Severity == "MEDIUM")] | length' fs-vulnerabilities.json 2>/dev/null || echo "0"),
                "LOW": $(jq '[.Results[].Vulnerabilities[]? | select(.Severity == "LOW")] | length' fs-vulnerabilities.json 2>/dev/null || echo "0")
              }
            },
            "secretsScan": {
              "secretsFound": $(jq '[.Results[].Secrets[]?] | length' secrets-config.json 2>/dev/null || echo "0")
            }
          },
          "reportFiles": {
            "sbom": "sbom.json",
            "sbomVulnerabilities": "sbom-vulnerabilities.json",
            "filesystemVulnerabilities": "fs-vulnerabilities.json",
            "secretsConfig": "secrets-config.json"
          }
        }
        EOF
        
        echo "Comprehensive JSON report generated"

    - name: Display scan summary
      run: |
        echo "=== TRIVY SECURITY SCAN SUMMARY ==="
        echo "ğŸ“Š Scan completed successfully!"
        echo ""
        echo "ğŸ“ Generated Reports:"
        echo "  ğŸ“‹ SBOM: sbom.json"
        echo "  ğŸ” SBOM Vulnerabilities: sbom-vulnerabilities.json"
        echo "  ğŸ›¡ï¸ Filesystem Vulnerabilities: fs-vulnerabilities.json"
        echo "  ğŸ”‘ Secrets & Config: secrets-config.json"
        echo "  ğŸ“ˆ Summary: comprehensive-security-report.json"
        echo ""
        
        # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ
        if [ -f "comprehensive-security-report.json" ]; then
          echo "ğŸ“ˆ Vulnerability Statistics:"
          jq -r '.vulnerabilitySummary.filesystemScan.vulnerabilitiesBySeverity | "  CRITICAL: \(.CRITICAL)\n  HIGH: \(.HIGH)\n  MEDIUM: \(.MEDIUM)\n  LOW: \(.LOW)"' comprehensive-security-report.json
          
          SECRETS_COUNT=$(jq '.vulnerabilitySummary.secretsScan.secretsFound' comprehensive-security-report.json)
          echo "  ğŸ”‘ Secrets found: $SECRETS_COUNT"
        fi

    - name: Upload all JSON reports as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: trivy-security-reports
        path: |
          sbom.json
          sbom-vulnerabilities.json
          fs-vulnerabilities.json
          secrets-config.json
          comprehensive-security-report.json
        retention-days: 30

    - name: Check for critical vulnerabilities
      if: always()
      run: |
        if [ -f "comprehensive-security-report.json" ]; then
          CRITICAL_COUNT=$(jq '.vulnerabilitySummary.filesystemScan.vulnerabilitiesBySeverity.CRITICAL' comprehensive-security-report.json)
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "::warning::Found $CRITICAL_COUNT CRITICAL vulnerabilities!"
            exit 1
          else
            echo "âœ… No CRITICAL vulnerabilities found"
          fi
        fi
