name: Trivy Scan

on:
  push:
    branches: [ main ]

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Run Trivy
      run: |
        docker run --rm \
          -v $PWD:/src \
          -w /src \
          aquasec/trivy:latest fs \
          --format json \
          --output trivy-results.json \
          .
    - name: Convert to HTML
      run: |
        echo "<html><body><pre>$(cat trivy-results.json | jq '.Results[] | .Vulnerabilities[] | {VulnerabilityID, PkgName, Severity, Title}' 2>/dev/null || echo 'No vulnerabilities found')</pre></body></html>" > trivy-report.html
    - name: Upload HTML report
      uses: actions/upload-artifact@v4
      with:
        name: trivy-results
        path: trivy-report.html
