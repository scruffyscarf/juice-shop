name: Trivy Security Scan with SBOM

on:
  push:
    branches: [ main ]

jobs:
  trivy-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install Trivy
      run: |
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
        trivy --version

    - name: Update Trivy database
      run: |
        trivy image --download-db-only

    - name: Generate SBOM
      run: |
        # Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ SBOM Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ CycloneDX
        trivy fs . --format cyclonedx --output sbom.json
        echo "SBOM generated successfully"

    - name: Scan SBOM for vulnerabilities
      run: |
        # Ð¡ÐºÐ°Ð½Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ°Ð¼ SBOM Ð½Ð° ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸
        trivy sbom sbom.json --format json --output sbom-vulnerabilities.json
        echo "SBOM vulnerability scan completed"

    - name: Scan filesystem for vulnerabilities
      run: |
        # ÐŸÐ¾Ð»Ð½Ð¾Ðµ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð²Ð¾Ð¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
        trivy fs . \
          --format json \
          --output fs-vulnerabilities.json \
          --scanners vuln \
          --severity CRITICAL,HIGH,MEDIUM,LOW
        echo "Filesystem vulnerability scan completed"

    - name: Scan for secrets and config issues
      run: |
        # Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð² Ð¸ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð¾Ð²
        trivy fs . \
          --format json \
          --output secrets-config.json \
          --scanners secret,config \
          --severity CRITICAL,HIGH,MEDIUM,LOW
        echo "Secrets and config scan completed"

    - name: Create comprehensive JSON report
      run: |
        # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ jq Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ JSON
        sudo apt-get install -y jq
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
        TRIVY_VERSION=$(trivy --version | head -1 | cut -d' ' -f2)
        TIMESTAMP=$(date -Iseconds)
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÑ‡ÐµÑ‚Ñ‡Ð¸ÐºÐ¸ Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¾Ð¹ Ð¾ÑˆÐ¸Ð±Ð¾Ðº
        SBOM_COMPONENTS=$(jq '.components | length' sbom.json 2>/dev/null || echo "0")
        SBOM_VULNS=$(jq '.Results | length' sbom-vulnerabilities.json 2>/dev/null || echo "0")
        FS_TARGETS=$(jq '.Results | length' fs-vulnerabilities.json 2>/dev/null || echo "0")
        
        # Ð¡Ñ‡ÐµÑ‚Ñ‡Ð¸ÐºÐ¸ ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
        CRITICAL=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' fs-vulnerabilities.json 2>/dev/null || echo "0")
        HIGH=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity == "HIGH")] | length' fs-vulnerabilities.json 2>/dev/null || echo "0")
        MEDIUM=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity == "MEDIUM")] | length' fs-vulnerabilities.json 2>/dev/null || echo "0")
        LOW=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity == "LOW")] | length' fs-vulnerabilities.json 2>/dev/null || echo "0")
        SECRETS=$(jq '[.Results[].Secrets[]?] | length' secrets-config.json 2>/dev/null || echo "0")
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐ²Ð¾Ð´Ð½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚
        cat > comprehensive-security-report.json << EOF
        {
          "scanMetadata": {
            "scanner": "Trivy",
            "version": "$TRIVY_VERSION",
            "timestamp": "$TIMESTAMP",
            "repository": "${{ github.repository }}",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}"
          },
          "sbomAnalysis": {
            "componentsCount": $SBOM_COMPONENTS,
            "vulnerabilitiesFound": $SBOM_VULNS
          },
          "vulnerabilitySummary": {
            "filesystemScan": {
              "targetsScanned": $FS_TARGETS,
              "vulnerabilitiesBySeverity": {
                "CRITICAL": $CRITICAL,
                "HIGH": $HIGH,
                "MEDIUM": $MEDIUM,
                "LOW": $LOW
              }
            },
            "secretsScan": {
              "secretsFound": $SECRETS
            }
          },
          "reportFiles": {
            "sbom": "sbom.json",
            "sbomVulnerabilities": "sbom-vulnerabilities.json",
            "filesystemVulnerabilities": "fs-vulnerabilities.json",
            "secretsConfig": "secrets-config.json"
          }
        }
        EOF
        
        echo "Comprehensive JSON report generated"

    - name: Display scan summary
      run: |
        echo "=== TRIVY SECURITY SCAN SUMMARY ==="
        echo "ðŸ“Š Scan completed successfully!"
        echo ""
        echo "ðŸ“ Generated Reports:"
        echo "  ðŸ“‹ SBOM: sbom.json"
        echo "  ðŸ” SBOM Vulnerabilities: sbom-vulnerabilities.json"
        echo "  ðŸ›¡ï¸ Filesystem Vulnerabilities: fs-vulnerabilities.json"
        echo "  ðŸ”‘ Secrets & Config: secrets-config.json"
        echo "  ðŸ“ˆ Summary: comprehensive-security-report.json"
        echo ""
        
        # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ Ð¸Ð· ÑÐ¾Ð·Ð´Ð°Ð½Ð½Ð¾Ð³Ð¾ JSON
        if [ -f "comprehensive-security-report.json" ]; then
          echo "ðŸ“ˆ Vulnerability Statistics:"
          CRITICAL=$(jq -r '.vulnerabilitySummary.filesystemScan.vulnerabilitiesBySeverity.CRITICAL' comprehensive-security-report.json)
          HIGH=$(jq -r '.vulnerabilitySummary.filesystemScan.vulnerabilitiesBySeverity.HIGH' comprehensive-security-report.json)
          MEDIUM=$(jq -r '.vulnerabilitySummary.filesystemScan.vulnerabilitiesBySeverity.MEDIUM' comprehensive-security-report.json)
          LOW=$(jq -r '.vulnerabilitySummary.filesystemScan.vulnerabilitiesBySeverity.LOW' comprehensive-security-report.json)
          SECRETS=$(jq -r '.vulnerabilitySummary.secretsScan.secretsFound' comprehensive-security-report.json)
          
          echo "  CRITICAL: $CRITICAL"
          echo "  HIGH: $HIGH"
          echo "  MEDIUM: $MEDIUM"
          echo "  LOW: $LOW"
          echo "  ðŸ”‘ Secrets found: $SECRETS"
        else
          echo "âŒ Summary report not found"
        fi

    - name: Upload all JSON reports as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: trivy-security-reports
        path: |
          sbom.json
          sbom-vulnerabilities.json
          fs-vulnerabilities.json
          secrets-config.json
          comprehensive-security-report.json
        retention-days: 30

    - name: Check for critical vulnerabilities
      if: always()
      run: |
        if [ -f "comprehensive-security-report.json" ]; then
          CRITICAL_COUNT=$(jq -r '.vulnerabilitySummary.filesystemScan.vulnerabilitiesBySeverity.CRITICAL' comprehensive-security-report.json)
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "::warning::Found $CRITICAL_COUNT CRITICAL vulnerabilities!"
            exit 1
          else
            echo "âœ… No CRITICAL vulnerabilities found"
          fi
        else
          echo "âŒ Cannot check critical vulnerabilities - report not found"
        fi
