name: Security Scan with JSON Report

on:
  push:
    branches: [ main ]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Trivy
      run: |
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

    - name: Update Trivy database
      run: |
        trivy image --download-db-only

    - name: Run comprehensive security scan
      run: |
        # –ü–æ–ª–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ
        trivy fs . --format json --output security-scan-results.json --scanners vuln,secret,config --severity CRITICAL,HIGH,MEDIUM,LOW
        
        # –¢–∞–∫–∂–µ –¥–µ–ª–∞–µ–º —Ç–∞–±–ª–∏—á–Ω—ã–π –≤—ã–≤–æ–¥ –¥–ª—è –ª–æ–≥–æ–≤
        trivy fs . --format table --scanners vuln,secret,config --severity CRITICAL,HIGH,MEDIUM,LOW

    - name: Analyze and display results summary
      run: |
        echo "=== SECURITY SCAN SUMMARY ==="
        
        if [ -f "security-scan-results.json" ]; then
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º jq –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON
          sudo apt-get install -y jq
          
          # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
          TOTAL_VULNS=$(jq '.Results | length' security-scan-results.json)
          CRITICAL_COUNT=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' security-scan-results.json)
          HIGH_COUNT=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity == "HIGH")] | length' security-scan-results.json)
          MEDIUM_COUNT=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity == "MEDIUM")] | length' security-scan-results.json)
          LOW_COUNT=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity == "LOW")] | length' security-scan-results.json)
          SECRETS_COUNT=$(jq '[.Results[].Secrets[]?] | length' security-scan-results.json)
          
          echo "üìä Scan Results:"
          echo "üõ°Ô∏è  Total targets scanned: $TOTAL_VULNS"
          echo "üî¥ CRITICAL vulnerabilities: $CRITICAL_COUNT"
          echo "üü† HIGH vulnerabilities: $HIGH_COUNT"
          echo "üü° MEDIUM vulnerabilities: $MEDIUM_COUNT"
          echo "üü¢ LOW vulnerabilities: $LOW_COUNT"
          echo "üîë Secrets found: $SECRETS_COUNT"
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä–æ–≤ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
          if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
            echo ""
            echo "üö® CRITICAL/HIGH VULNERABILITIES FOUND:"
            jq -r '.Results[].Vulnerabilities[]? | select(.Severity == "CRITICAL" or .Severity == "HIGH") | "\(.Severity): \(.VulnerabilityID) - \(.Title)"' security-scan-results.json | head -10
          fi
          
          if [ "$SECRETS_COUNT" -gt 0 ]; then
            echo ""
            echo "üîç SECRETS FOUND:"
            jq -r '.Results[].Secrets[]? | "SECRET: \(.Category) - \(.Title)"' security-scan-results.json | head -5
          fi
          
        else
          echo "‚ùå No scan results found"
        fi

    - name: Upload JSON report as artifact
      uses: actions/upload-artifact@v4
      with:
        name: security-scan-results
        path: |
          security-scan-results.json
        retention-days: 30

    - name: Check for critical vulnerabilities
      if: always()
      run: |
        if [ -f "security-scan-results.json" ]; then
          CRITICAL_COUNT=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' security-scan-results.json)
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "::warning::Found $CRITICAL_COUNT CRITICAL vulnerabilities!"
            exit 1
          else
            echo "‚úÖ No CRITICAL vulnerabilities found"
          fi
        fi
